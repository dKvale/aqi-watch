---
output:
  html_document:
    highlight: tango
    keep_md: no
    toc: no
    css: flat_table.css
---
    
<script type="text/JavaScript">
setTimeout(function() { window.location=window.location;},400000);
</script>

# AQI Watch

### 1-hr AQI _(PM2.5, O3, PM10)_
 
<div style = "margin-left: 4px;"> 
_Last updated - `r format(Sys.time(), " %h %d, %Y  %H:%M")` CDT_
</div>
 
```{r leafMap, message=F, echo=F, warning=F,  fig.height = 5.62}
library(leaflet)
#library(htmltools)

options(warn = -1)

legend_colors <- c('#00e400', '#ffff00', '#ff7e00', '#ff0000', '#99004c', '#7e0023')

breaks <- c(0, 50, 100, 150, 200, 300, 700)

data <- aqi_rank 

data$aqi_color <- cut(data$AQI_Value, 
                     breaks = breaks, 
                     labels = legend_colors,
                     include.lowest = T)

data <- mutate(data, Popup = paste0("<b style='font-size: 150%;'>", `Site Name`,  "</b></br>", 
                                    #"</br> AQS-ID: ", AqsID,
                                    "</br> 1-hr AQI: ", AQI_Value,
                                    "</br> Concentration: ", Concentration,
                                    "</br> Parameter: ", Parameter,
                                    "</br> Sampling Hour: ", Time,
                                    "</br> Date: ", Date))

data <- left_join(data, locations[ , -2]) %>% arrange(AQI_Value)

data <- group_by(data, AqsID) %>%
        mutate(circle_scale = round(min(max(AQI_Value ** 0.5, 4.5), 12, na.rm = T), 1))

map <- leaflet(data[, c(9,13:17)], width='99%') %>%
       setView(lat = 46.1, lng= -95.2, zoom= 6) %>%
       addProviderTiles("CartoDB.Positron") %>%
       addCircleMarkers(~Long, ~Lat, 
                  popup = ~Popup, 
                  radius = ~circle_scale, 
                  fillColor = ~aqi_color,
                  color = 'gray',
                  weight = 2, 
                  fillOpacity = 0.65,
                  opacity = 0.5)

map 
```

<br>

# {.tabset}


## Elevated sites (1-hr AQI) 

### Elevated sites

##### Current air monitors reporting concentrations above a __1-hr AQI__ of 85. A __1-hr AQI__ corresponds to the AQI value that would result from the most recently reported concentration persisting over the entire AQI averaging period.

<div class = "orange">
```{r kable, message=F, echo=F, results='asis', warning=F}
library(knitr)
library(dplyr)


data <- filter(aqi_rank, AQI_Value >= 85) 

data <- data[ , c(1:4,8,5,7,9)]

names(data)[c(2,7,8)] <- c("Sampling Hour", "Concentration (ug/m3)", "1-hr AQI")

kable(data, 'html', align = 'c')

if(nrow(data) < 1) {
  cat(" *The table is currently empty.  All sites are reporting concentrations below a 1-hr AQI of 85.")
} 

```
<br></div>

<div class = "gray">
### Missing parameters
```{r miss_high, message=F, echo=F, results='asis', warning=F}

aqi$Site_Param <- paste(aqi$AqsID, aqi$Parameter, sep="_") 

missing_sites <- site_params[!site_params$Site_Param %in% aqi$Site_Param, ]

kable(arrange(missing_sites[ , 1:4], AqsID), 'html', align = 'c')

if(length(missing_sites) < 1) {
  cat(" *There were no missing sites or parameters.")
} 
```
<br></div>

## MN sites (1-hr AQI) 

### Minnesota sites (1-hr AQI) 
```{r kable2, message=F, echo=F, results='asis', warning=F}
library(knitr)

options(warn = -1)

data <- filter(aqi_rank, grepl("Minnesota", Agency) | AqsID %in% border_sites)

data <- data[ , c(1:4,8,5,7,9)]

data$Agency <- gsub("Minnesota Pollution Control Agency", "MPCA", data$Agency)

names(data)[c(2,7,8)] <- c("Sampling Hour", "Concentration (ug/m3)", "1-hr AQI")

kable(data, 'html', align = 'c')

if(nrow(data) < 1) {
  cat(" *The table is currently empty. ")
} 
```
<br>

<div class = "gray">
### Missing parameters from Minnesota
```{r miss_MN, message=F, echo=F, results='asis', warning=F}

mn_sites <- filter(site_params, substring(AqsID, 1, 2) == '27' | AqsID %in% border_sites)

missing_mn <- mn_sites[!mn_sites$Site_Param %in% aqi$Site_Param, ]

kable(arrange(missing_mn[ , 1:4], `Site Name`), 'html', align = 'c')

if(length(missing_mn) < 1) {
  cat(" *There were no missing sites or parameters.")
} 
```
<br></div>

## Neighbor sites (1-hr AQI)   
### Neighbor sites (1-hr AQI) 

```{r kable3, message=F, echo=F, results='asis', warning=F}
library(knitr)

options(warn = -1)

data <- filter(aqi_rank, !grepl("Minnesota", Agency),  !AqsID %in% border_sites)

data <- data[ , c(1:4,8,5,7,9)]

names(data)[c(2,7,8)] <- c("Sampling Hour", "Concentration (ug/m3)", "1-hr AQI")

kable(data, 'html', align = 'c')

if(nrow(data) < 1) {
  cat(" *The table is currently empty. ")
} 
```
<br>

<div class = "gray">
### Missing parameters from neighbor sites
```{r miss_nearby, message=F, echo=F, results='asis', warning=F}

missing_sites <- filter(site_params, substring(AqsID, 1, 2) != '27' & !AqsID %in% border_sites)

missing_sites <- missing_sites[!missing_sites$Site_Param %in% aqi$Site_Param, ]

aqi$Site_Param <- NULL

kable(arrange(missing_sites[ , 1:4], `Site Name`), 'html', align = 'c')

if(length(missing_mn) < 1) {
  cat(" *There were no missing sites or parameters.")
} 
```
<br></div>

## NowCast map

### NowCast map
[<img src="http://files.airnowtech.org/airnow/today/cur_aqi_usa.jpg" alt="Current AQI map for the U.S." width="75%" style="float:left; margin-left:1%; margin-right:1%; margin-bottom:2%;"/>](https://www.airnow.gov/index.cfm?action=airnow.local_state&stateid=24&mapcenter=0&tabs=1)
<br>

## NowCast values
### NowCast values
_Smogwatch, SonomaTech_

<div style="margin-left: -10%; margin-top:-10px; margin-right:50px;">

<iframe src="http://www.smogwatch.com/minn/realtimedata.cfm" overflow="visible" frameborder="0" scrolling="no" style="width: 1100px; height: 1110px;"> </iframe> 

</div>
<br><br>
<hr>
<br>
